<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Поток Кадров — Viora</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<a class="back-link" href="/viora">← Назад</a>

<div class="editor-page">
  <div class="canvas-area" id="canvasArea">
    <svg class="connector-svg" id="connectors" width="100%" height="100%"></svg>

    <!-- Главный кадр -->
    <div class="node" id="node-root" style="left: calc(50% - 130px); top: 80px;" data-id="root">
      <div contenteditable class="title" data-placeholder="Опишите главный кадр...">Опишите главный кадр</div>
      <div style="display:flex; justify-content:space-between; align-items:center">
        <div class="small-muted">Главный кадр</div>
        <div class="add-btn" title="Добавить исход">+</div>
      </div>
    </div>
  </div>

  <div class="side-panel">
    <h3>ИИ-режиссёр (Поток кадров)</h3>
    <div class="small-muted">У каждого кадра допускается только один исход. Чтобы заменить — удалите существующий.</div>

    <div style="height:12px"></div>
    <div style="font-weight:600">Главный кадр</div>
    <div id="ai-title" class="small-muted"></div>

    <div style="height:10px"></div>
    <div style="font-weight:600">Исход</div>
    <div id="ai-outcome" class="small-muted"></div>

    <div style="height:12px"></div>
    <div class="ai-box" id="ai-output">Нажмите «Предложить кадр», чтобы ИИ сгенерировал следующий кадр.</div>

    <div style="height:12px"></div>
    <div style="display:flex; gap:10px">
      <button class="button-primary" id="ai-run">Предложить кадр</button>
      <button class="button-ghost" id="ai-clear">Очистить все исходы</button>
    </div>
  </div>
</div>

<script>
// --- JS для flow.html ---
const canvas = document.getElementById('canvasArea');
const connectorsSvg = document.getElementById('connectors');
const edges = [];

function byId(id){ return document.querySelector(`[data-id="${id}"]`); }

function makeDraggable(elem){
  let dragging=false, dx=0, dy=0;
  elem.addEventListener('mousedown', e=>{
    if(e.target.closest('.add-btn')||e.target.closest('.remove-btn')) return;
    dragging=true;
    const rect=elem.getBoundingClientRect();
    dx=e.clientX-rect.left;
    dy=e.clientY-rect.top;
    elem.style.zIndex=1000;
  });
  document.addEventListener('mousemove', e=>{
    if(!dragging) return;
    const rect=canvas.getBoundingClientRect();
    elem.style.left=(e.clientX-rect.left-dx)+'px';
    elem.style.top=(e.clientY-rect.top-dy)+'px';
    renderConnections();
  });
  document.addEventListener('mouseup', ()=>{ if(dragging){dragging=false; elem.style.zIndex='';} });
}

function createNodeAt(x,y,text,parentId){
  const id='node-'+Date.now()+'-'+Math.floor(Math.random()*1000);
  const div=document.createElement('div');
  div.className='node';
  div.style.left=x+'px';
  div.style.top=y+'px';
  div.dataset.id=id;
  div.innerHTML=`
    <div contenteditable class="title" data-placeholder="Опишите кадр...">${text}</div>
    <div style="display:flex; justify-content:space-between; align-items:center">
      <div class="small-muted">Кадр</div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="add-btn" title="Добавить исход">+</div>
        <div class="remove-btn" title="Удалить узел">✕</div>
      </div>
    </div>
  `;
  canvas.appendChild(div);
  makeDraggable(div);
  setupNodeButtons(div);
  if(parentId){ edges.push({from: parentId, to: id}); const parent=byId(parentId); if(parent){parent.dataset.childId=id; parent.querySelector('.add-btn')?.setAttribute('disabled','');} }
  updateAIPreview();
  renderConnections();
  return id;
}

function removeNode(nodeId){
  const node=byId(nodeId);
  if(!node) return;
  for(let i=edges.length-1;i>=0;i--){if(edges[i].from===nodeId||edges[i].to===nodeId) edges.splice(i,1);}
  if(node.dataset.childId){ delete node.dataset.childId; }
  node.remove();
  renderConnections();
  updateAIPreview();
}

function renderConnections(){
  connectorsSvg.innerHTML='';
  edges.forEach(e=>{
    const a=byId(e.from), b=byId(e.to);
    if(!a||!b) return;
    const ra=a.getBoundingClientRect(), rb=b.getBoundingClientRect();
    const cr=canvas.getBoundingClientRect();
    const x1=ra.left+ra.width/2-cr.left, y1=ra.top+ra.height-cr.top;
    const x2=rb.left+rb.width/2-cr.left, y2=rb.top-cr.top;
    const path=document.createElementNS('http://www.w3.org/2000/svg','path');
    const dx=Math.max(40,Math.abs(x2-x1)/2);
    path.setAttribute('d',`M ${x1} ${y1} C ${x1} ${y1+dx} ${x2} ${y2-dx} ${x2} ${y2}`);
    path.setAttribute('stroke','rgba(255,255,255,0.12)');
    path.setAttribute('stroke-width','2');
    path.setAttribute('fill','none');
    connectorsSvg.appendChild(path);
  });
}

function setupNodeButtons(node){
  const addBtn=node.querySelector('.add-btn');
  const removeBtn=node.querySelector('.remove-btn');
  const title=node.querySelector('.title');

  addBtn?.addEventListener('click', e=>{
    e.stopPropagation();
    const rect=node.getBoundingClientRect();
    const cr=canvas.getBoundingClientRect();
    createNodeAt(rect.left-cr.left+rect.width+40, rect.top-cr.top, 'Следующий кадр...', node.dataset.id);
  });

  removeBtn?.addEventListener('click', e=>{
    e.stopPropagation();
    removeNode(node.dataset.id);
  });

  title?.addEventListener('input', updateAIPreview);
}

function collectTreeForAI(){
  const root=byId('root');
  const seen=[];
  function traverse(id){
    const node=byId(id);
    if(!node) return;
    const txt=node.querySelector('.title')?.innerText.trim()||'';
    seen.push({id,text:txt});
    const childId=node.dataset.childId;
    if(childId) traverse(childId);
  }
  traverse('root');
  return seen;
}

function updateAIPreview(){
  const tree=collectTreeForAI();
  document.getElementById('ai-title').innerText=tree[0]?.text||'—';
  document.getElementById('ai-outcome').innerText=tree[1]?.text||'—';
}

document.getElementById('ai-run').addEventListener('click', async ()=>{
  const tree=collectTreeForAI();
  const title=tree[0]?.text||'';
  const outcome=tree[1]?.text||'';
  const outBox=document.getElementById('ai-output');
  if(!title){outBox.innerText='Опишите главный кадр.'; return;}
  if(!outcome){outBox.innerText='Добавьте хотя бы один исход.'; return;}
  outBox.innerText='Обрабатываем...';
  try{
    const resp=await fetch('main.py/runAi',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({title,outcomes:[outcome]})
    });
    const data=await resp.json();
    outBox.innerText=data.result;
  }catch(err){console.error(err); outBox.innerText='Ошибка при запросе к AI.';}
});

document.getElementById('ai-clear').addEventListener('click', ()=>{
  const all=Array.from(document.querySelectorAll('.node')).map(n=>n.dataset.id);
  for(const id of all){ if(id!=='root') removeNode(id); }
  const root=byId('root'); if(root){delete root.dataset.childId; root.querySelector('.add-btn')?.removeAttribute('disabled');}
  edges.length=0;
  renderConnections();
  updateAIPreview();
  document.getElementById('ai-output').innerText='Все исходы удалены.';
});

document.querySelectorAll('.node').forEach(n=>{ makeDraggable(n); setupNodeButtons(n); });
window.addEventListener('resize', renderConnections);
canvas.addEventListener('scroll', renderConnections);
updateAIPreview();
renderConnections();
</script>
</body>
</html>
