<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>–ü–æ—Ç–æ–∫ –ö–∞–¥—Ä–æ–≤ ‚Äî Viora</title>
    <style>
        :root {
            --panel-bg: rgba(8,8,10,0.6);
            --accent: #7dd3fc;
            --neon: rgba(0,217,255,0.70);
            --bg-dark: #09090b;
            --glass-bg: rgba(10,10,15,0.45);
            --glass-border: rgba(255,255,255,0.08);
            --text-primary: #fff;
            --text-muted: rgba(255,255,255,0.6);
            --pro-color: #10b981;
            --con-color: #ef4444;
            --visual-color: #8b5cf6;
            --emotional-color: #f59e0b;
            --frame-color: #7dd3fc;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            font-family: Inter, Arial, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            touch-action: none;
        }

        .editor-page {
            width: 100vw;
            height: 100vh;
            display: flex;
            gap: 10px;
            padding: 10px;
            box-sizing: border-box;
            align-items: stretch;
            position: relative;
            overflow: hidden;
        }

        .canvas-area {
            flex: 1 1 auto;
            border-radius: 12px;
            background: var(--glass-bg);
            backdrop-filter: blur(6px);
            position: relative;
            overflow: auto;
            padding: 20px;
            min-width: max-content;
            min-height: max-content;
            touch-action: pan-x pan-y;
            -webkit-overflow-scrolling: touch;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: var(--bg-dark);
        }

        .canvas-transform {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform-origin: 0 0;
            transition: transform 0.1s ease-out;
        }

        .canvas-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 10000px;
            height: 10000px;
            background: var(--bg-dark);
        }

        .canvas-pan-cursor { cursor: grab; }
        .canvas-panning { cursor: grabbing !important; }

        .side-panel {
            position: absolute;
            right: 10px;
            top: 10px;
            width: 320px;
            max-width: 90vw;
            height: calc(100vh - 40px);
            max-height: 70vh;
            background: var(--panel-bg);
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            z-index: 1000;
            touch-action: none;
        }

        .side-panel.hidden {
            display: none;
        }

        .open-panel-btn {
            position: fixed;
            top: 50px;
            right: 10px;
            background: var(--accent);
            color: #0a0a0f;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 999;
            display: none;
        }

        .open-panel-btn.visible {
            display: block;
        }

        .side-header {
            cursor: grab;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            margin-bottom: 8px;
            border-radius: 6px;
            -webkit-user-select: none;
        }

        .side-title {
            font-weight: 700;
            font-size: 16px;
        }

        .node {
            width: 90vw;
            max-width: 300px;
            min-height: 80px;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 12px;
            position: absolute;
            display: flex;
            flex-direction: column;
            gap: 8px;
            cursor: move;
            z-index: 10;
            transition: transform 0.2s ease;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        .node:active {
            cursor: grabbing;
            z-index: 1000;
        }

        .node:hover {
            transform: scale(1.02);
        }

        .node .title {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            outline: none;
            min-height: 20px;
            background: transparent;
            border: none;
            width: 100%;
            cursor: text;
            -webkit-user-select: text;
            user-select: text;
            padding: 2px;
        }

        .title[contenteditable]:empty:before {
            content: attr(data-placeholder);
            color: rgba(255,255,255,0.35);
            display: block;
        }

        .controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 6px;
        }

        .buttons-container {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .add-btn, .remove-btn, .toggle-btn, .next-frame-btn, .analyze-btn {
            width: 32px;
            height: 32px;
            min-width: 32px;
            min-height: 32px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.06);
            color: var(--text-primary);
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            -webkit-user-select: none;
            touch-action: manipulation;
            font-size: 16px;
        }

        .add-btn:hover, .next-frame-btn:hover {
            background: rgba(0,217,255,0.2);
            border-color: rgba(0,217,255,0.4);
        }

        .remove-btn:hover {
            background: rgba(255,68,68,0.2);
            border-color: rgba(239,68,68,0.4);
        }

        .analyze-btn:hover {
            background: rgba(139,92,246,0.2);
            border-color: rgba(139,92,246,0.4);
        }

        .small-muted {
            color: var(--text-muted);
            font-size: 12px;
        }

        .connector-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 10000px;
            height: 10000px;
            pointer-events: none;
            z-index: 1;
        }

        .connector-svg path {
            stroke: var(--neon) !important;
            stroke-width: 3 !important;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
            opacity: 0.98;
            filter: drop-shadow(0 0 6px rgba(0,217,255,0.25));
        }

        .ai-box {
            background: rgba(255,255,255,0.02);
            padding: 10px;
            border-radius: 8px;
            min-height: 100px;
            overflow: auto;
            max-height: 40vh;
            font-size: 14px;
            line-height: 1.4;
            -webkit-overflow-scrolling: touch;
        }

        .ai-box .ai-response {
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255,255,255,0.02);
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.04);
        }

        .ai-box .ai-response .meta {
            font-size: 12px;
            color: rgba(255,255,255,0.85);
        }

        .action-row {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .button-primary, .button-ghost, .button-danger, .button-special {
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            font-size: 14px;
            touch-action: manipulation;
            min-height: 44px;
            min-width: 44px;
            flex: 1;
        }

        .button-primary {
            background: var(--accent);
            color: #0a0a0f;
        }

        .button-primary:hover {
            box-shadow: 0 0 12px rgba(0,217,255,0.5);
        }

        .button-special {
            background: var(--frame-color);
            color: white;
        }

        .button-special:hover {
            box-shadow: 0 0 12px rgba(139,92,246,0.5);
        }

        .button-ghost {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid rgba(255,255,255,0.08);
        }

        .button-ghost:hover {
            background: rgba(255,255,255,0.05);
        }

        .button-danger {
            background: rgba(239,68,68,0.1);
            color: #ef4444;
            border: 1px solid rgba(239,68,68,0.2);
        }

        .button-danger:hover {
            background: rgba(239,68,68,0.2);
        }

        .back-link {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1100;
            background: rgba(255,255,255,0.06);
            color: var(--text-primary);
            text-decoration: none;
            display: inline-flex;
            gap: 6px;
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.08);
            font-weight: 600;
            transition: all 0.2s ease;
            touch-action: manipulation;
            min-height: 40px;
            min-width: 40px;
            align-items: center;
            font-size: 14px;
        }

        .back-link:hover {
            background: rgba(0,217,255,0.15);
            border-color: rgba(0,217,255,0.4);
        }

        .node[data-type="frame"] {
            border-left: 4px solid rgba(125,211,252,0.5);
            background: rgba(125,211,252,0.08);
        }

        .node[data-type="visual"] {
            border-left: 4px solid rgba(139,92,246,0.3);
            background: rgba(139,92,246,0.05);
        }

        .node[data-type="emotional"] {
            border-left: 4px solid rgba(245,158,11,0.3);
            background: rgba(245,158,11,0.05);
        }

        .node[data-type="visual-container"] {
            border-left: 4px solid rgba(139,92,246,0.5);
            background: rgba(139,92,246,0.08);
            font-weight: 700;
            font-size: 14px;
            color: var(--visual-color);
        }

        .node[data-type="emotional-container"] {
            border-left: 4px solid rgba(245,158,11,0.5);
            background: rgba(245,158,11,0.08);
            font-weight: 700;
            font-size: 14px;
            color: var(--emotional-color);
        }

        .zoom-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: var(--panel-bg);
            border-radius: 8px;
            padding: 8px;
            border: 1px solid var(--glass-border);
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s ease;
        }

        .zoom-btn:hover {
            background: rgba(0,217,255,0.2);
            border-color: rgba(0,217,255,0.4);
        }

        .zoom-display {
            text-align: center;
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .frame-analysis-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            backdrop-filter: blur(4px);
        }

        .frame-analysis-modal.active {
            display: flex;
        }

        .frame-analysis-content {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 20px;
            max-width: 90vw;
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            border: 1px solid var(--glass-border);
        }

        .frame-list {
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
            background: rgba(255,255,255,0.02);
            border-radius: 8px;
            padding: 10px;
        }

        .frame-item {
            padding: 8px;
            margin: 4px 0;
            background: rgba(255,255,255,0.03);
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .frame-item:hover {
            background: rgba(139,92,246,0.1);
            border-color: rgba(139,92,246,0.3);
        }

        .frame-item.selected {
            background: rgba(139,92,246,0.2);
            border-color: var(--frame-color);
        }

        .visual-list, .emotional-list {
            margin: 8px 0;
            padding-left: 16px;
        }

        .visual-list li, .emotional-list li {
            margin: 4px 0;
            font-size: 12px;
            line-height: 1.3;
        }

        .visual-list {
            color: var(--visual-color);
        }

        .emotional-list {
            color: var(--emotional-color);
        }

        @media (max-width: 768px) {
            .editor-page {
                flex-direction: column;
                padding: 5px;
                gap: 5px;
            }
            .canvas-area {
                padding: 15px;
                min-height: 60vh;
                border-radius: 10px;
            }
            .side-panel {
                position: relative;
                width: 100%;
                max-width: 100%;
                height: auto;
                max-height: 50vh;
                right: auto;
                top: auto;
                margin-top: 5px;
                padding: 8px;
            }
            .node {
                width: 90vw;
                max-width: 280px;
                padding: 10px;
                min-height: 70px;
                border-radius: 12px;
            }
            .zoom-controls {
                bottom: 10px;
                right: 10px;
            }
            .frame-analysis-content {
                width: 95vw;
                padding: 15px;
            }
        }
    </style>
</head>
<body class="no-select">
    <a class="back-link" href="/">‚Üê –ù–∞–∑–∞–¥</a>
    <button class="open-panel-btn" id="openPanelBtn">–û—Ç–∫—Ä—ã—Ç—å –ò–ò</button>

    <div class="zoom-controls">
        <button class="zoom-btn" id="zoomIn" title="–£–≤–µ–ª–∏—á–∏—Ç—å">+</button>
        <button class="zoom-btn" id="zoomOut" title="–£–º–µ–Ω—å—à–∏—Ç—å">‚àí</button>
        <button class="zoom-btn" id="resetZoom" title="–°–±—Ä–æ—Å–∏—Ç—å –º–∞—Å—à—Ç–∞–±">‚Ü∫</button>
        <div class="zoom-display" id="zoomLevel">100%</div>
    </div>

    <div class="editor-page" id="editorPage">
        <div class="canvas-area canvas-pan-cursor" id="canvasArea">
            <div class="canvas-container" id="canvasContainer">
                <div class="canvas-transform" id="canvasTransform">
                    <div class="canvas-content" id="canvasContent">
                        <svg class="connector-svg" id="connectors"></svg>

                        <div class="node" id="node-root" style="left: calc(50% - 110px); top: 80px;" data-id="root" data-type="frame">
                            <div contenteditable class="title" data-placeholder="–û–ø–∏—à–∏—Ç–µ —Å—Ü–µ–Ω—É...">–ù–∞—á–Ω–∏—Ç–µ —Å –ø–µ—Ä–≤–æ–≥–æ –∫–∞–¥—Ä–∞</div>
                            <div class="controls">
                                <div class="small-muted">–ù–∞—á–∞–ª—å–Ω—ã–π –∫–∞–¥—Ä</div>
                                <div class="buttons-container">
                                    <div class="add-btn" title="–î–æ–±–∞–≤–∏—Ç—å –∫–∞–¥—Ä" data-add>+</div>
                                    <div class="next-frame-btn" title="–°–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä (–ò–ò)" data-next-frame>‚Üí</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="side-panel" id="sidePanel" role="region" aria-label="–ò–ò-–ø–∞–Ω–µ–ª—å">
            <div class="side-header" id="sideHeader">
                <div>
                    <div class="side-title">–†–µ–∂–∏—Å—Å–µ—Ä –ò–ò</div>
                    <div class="small-muted">–ê–Ω–∞–ª–∏–∑ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞–¥—Ä–æ–≤</div>
                </div>
                <div style="display:flex;gap:8px;align-items:center">
                    <button id="panelCloseBtn" class="button-ghost" title="–°–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å">‚úï</button>
                </div>
            </div>

            <div style="font-weight:600">–¢–µ–º–∞ —Å—Ü–µ–Ω—ã</div>
            <div id="ai-title" class="small-muted" style="min-height:34px">‚Äî</div>

            <div style="height:10px"></div>
            <div style="font-weight:600">–¢–µ–∫—É—â–∏–µ –∫–∞–¥—Ä—ã</div>
            <div id="ai-outcomes" class="small-muted" style="min-height:60px">‚Äî</div>

            <div style="height:12px"></div>
            <div class="ai-box" id="ai-output">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞–¥—Ä–æ–≤ –∏–ª–∏ –∞–Ω–∞–ª–∏–∑–∞ —Å—Ü–µ–Ω—ã.</div>

            <div class="action-row" style="margin-top:12px">
                <button class="button-primary" id="ai-next-frame">–°–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä (–ò–ò)</button>
                <button class="button-special" id="ai-analyze-frames">–ê–Ω–∞–ª–∏–∑ –∫–∞–¥—Ä–æ–≤</button>
            </div>

            <div style="height:8px"></div>
            <div class="small-muted">–¢–∞–π–º–µ—Ä –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: <span id="ai-timer">‚Äî</span></div>
        </div>
    </div>

    <!-- Modal –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–∞–¥—Ä–æ–≤ -->
    <div class="frame-analysis-modal" id="frameAnalysisModal">
        <div class="frame-analysis-content">
            <div style="font-weight:600;font-size:18px;margin-bottom:15px;">–í—ã–±–æ—Ä –∫–∞–¥—Ä–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</div>
            <div class="small-muted" style="margin-bottom:15px;">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–¥—Ä—ã –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∏ –∞–Ω–∞–ª–∏–∑–∞:</div>

            <div class="frame-list" id="frameList">
                <!-- –°–ø–∏—Å–æ–∫ –∫–∞–¥—Ä–æ–≤ –±—É–¥–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
            </div>

            <div class="action-row" style="margin-top:20px;">
                <button class="button-ghost" id="modalCancel">–û—Ç–º–µ–Ω–∞</button>
                <button class="button-special" id="modalAnalyze">–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>
    </div>

<script>
// ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
const STORAGE_KEY = 'viora_flow_state_v3';
const canvas = document.getElementById('canvasArea');
const canvasContainer = document.getElementById('canvasContainer');
const canvasTransform = document.getElementById('canvasTransform');
const canvasContent = document.getElementById('canvasContent');
const connectorsSvg = document.getElementById('connectors');
const sidePanel = document.getElementById('sidePanel');
const sideHeader = document.getElementById('sideHeader');
const panelCloseBtn = document.getElementById('panelCloseBtn');
const openPanelBtn = document.getElementById('openPanelBtn');
const frameAnalysisModal = document.getElementById('frameAnalysisModal');
const frameList = document.getElementById('frameList');
const modalCancel = document.getElementById('modalCancel');
const modalAnalyze = document.getElementById('modalAnalyze');
const zoomInBtn = document.getElementById('zoomIn');
const zoomOutBtn = document.getElementById('zoomOut');
const resetZoomBtn = document.getElementById('resetZoom');
const zoomLevelDisplay = document.getElementById('zoomLevel');
const aiNextFrameBtn = document.getElementById('ai-next-frame');
const aiAnalyzeFramesBtn = document.getElementById('ai-analyze-frames');

let edges = [];
let nodeCounter = 1;
const MAX_RETRIES = 4;
let isLockedUntil = 0;
let timerInterval = null;
let _saveTimeout = null;
let selectedFramesForAnalysis = new Set();

// –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –ú–ê–°–®–¢–ê–ë–ò–†–û–í–ê–ù–ò–Ø
let scale = 1;
let translateX = 0;
let translateY = 0;
let isPanning = false;
let panStart = { x: 0, y: 0 };
let startTranslate = { x: 0, y: 0 };

const ZOOM_CONFIG = {
    min: 0.1,
    max: 3.0,
    step: 0.1,
    default: 1.0
};

// –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –†–ê–°–ü–û–õ–û–ñ–ï–ù–ò–Ø –ò –ì–†–ê–ù–ò–¶
const LAYOUT_CONFIG = {
  NODE_WIDTH: 300,
  NODE_HEIGHT: 80,
  COLUMN_SPACING: 400,
  ROW_SPACING: 150,
  CANVAS_WIDTH: 5000,
  CANVAS_HEIGHT: 5000
};

// –ì—Ä–∞–Ω–∏—Ü—ã –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –±–ª–æ–∫–æ–≤ (—É–º–µ–Ω—å—à–µ–Ω—ã –¥–ª—è –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã)
const BOUNDARIES = {
  minX: 50,
  minY: 50,
  maxX: LAYOUT_CONFIG.CANVAS_WIDTH - LAYOUT_CONFIG.NODE_WIDTH - 50,
  maxY: LAYOUT_CONFIG.CANVAS_HEIGHT - LAYOUT_CONFIG.NODE_HEIGHT - 50
};

// ========== –§–£–ù–ö–¶–ò–ò –ú–ê–°–®–¢–ê–ë–ò–†–û–í–ê–ù–ò–Ø ==========
function updateTransform() {
    canvasTransform.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    zoomLevelDisplay.textContent = `${Math.round(scale * 100)}%`;
    renderConnections();
    saveState();
}

function zoomToPoint(zoomFactor, clientX, clientY) {
    const rect = canvasContainer.getBoundingClientRect();
    const pointX = clientX - rect.left;
    const pointY = clientY - rect.top;

    const worldX = (pointX - translateX) / scale;
    const worldY = (pointY - translateY) / scale;

    scale = Math.max(ZOOM_CONFIG.min, Math.min(ZOOM_CONFIG.max, zoomFactor));

    translateX = pointX - worldX * scale;
    translateY = pointY - worldY * scale;

    updateTransform();
}

function zoomIn() {
    const newScale = Math.min(ZOOM_CONFIG.max, scale + ZOOM_CONFIG.step);
    const rect = canvasContainer.getBoundingClientRect();
    zoomToPoint(newScale, rect.width / 2, rect.height / 2);
}

function zoomOut() {
    const newScale = Math.max(ZOOM_CONFIG.min, scale - ZOOM_CONFIG.step);
    const rect = canvasContainer.getBoundingClientRect();
    zoomToPoint(newScale, rect.width / 2, rect.height / 2);
}

function resetZoom() {
    scale = ZOOM_CONFIG.default;
    translateX = 0;
    translateY = 0;
    updateTransform();
}

function centerOnRoot() {
    const root = byId('root');
    if(!root) return;

    const rootX = parseFloat(root.style.left) || LAYOUT_CONFIG.CANVAS_WIDTH / 2;
    const rootY = parseFloat(root.style.top) || LAYOUT_CONFIG.CANVAS_HEIGHT / 2;

    const containerWidth = canvasContainer.clientWidth;
    const containerHeight = canvasContainer.clientHeight;

    translateX = -rootX * scale + containerWidth / 2;
    translateY = -rootY * scale + containerHeight / 2;

    updateTransform();
}

// –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ú–ê–°–®–¢–ê–ë–ò–†–û–í–ê–ù–ò–Ø
zoomInBtn.addEventListener('click', zoomIn);
zoomOutBtn.addEventListener('click', zoomOut);
resetZoomBtn.addEventListener('click', resetZoom);

// –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –≤ zoom-–∫–æ–Ω—Ç—Ä–æ–ª—ã
const zoomControls = document.querySelector('.zoom-controls');
const centerBtn = document.createElement('button');
centerBtn.className = 'zoom-btn';
centerBtn.id = 'centerRoot';
centerBtn.title = '–¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω–æ–º –±–ª–æ–∫–µ';
centerBtn.textContent = '‚åñ';
zoomControls.appendChild(centerBtn);
centerBtn.addEventListener('click', centerOnRoot);

canvasContainer.addEventListener('wheel', (e) => {
    e.preventDefault();
    const zoomFactor = e.deltaY > 0 ? scale - ZOOM_CONFIG.step : scale + ZOOM_CONFIG.step;
    zoomToPoint(zoomFactor, e.clientX, e.clientY);
});

// –ü–ê–ù–ù–û–†–ê–ú–ò–†–û–í–ê–ù–ò–ï
canvasContainer.addEventListener('mousedown', (e) => {
    const target = e.target;
    if (target.closest('.node') || target.closest('.add-btn') || target.closest('.remove-btn') || target.closest('.title')) return;
    if (e.button !== 0) return;

    isPanning = true;
    panStart.x = e.clientX;
    panStart.y = e.clientY;
    startTranslate.x = translateX;
    startTranslate.y = translateY;

    canvasContainer.classList.add('canvas-panning');
    document.body.style.userSelect = 'none';
});

document.addEventListener('mousemove', (e) => {
    if (!isPanning) return;
    const dx = e.clientX - panStart.x;
    const dy = e.clientY - panStart.y;
    translateX = startTranslate.x + dx;
    translateY = startTranslate.y + dy;
    updateTransform();
});

document.addEventListener('mouseup', () => {
    if (!isPanning) return;
    isPanning = false;
    canvasContainer.classList.remove('canvas-panning');
    document.body.style.userSelect = '';
    saveState();
});

// ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–û–ó–ò–¶–ò–Ø–ú–ò –° –ì–†–ê–ù–ò–¶–ê–ú–ò ==========
let occupiedPositions = new Map();

function resetOccupiedPositions() {
  occupiedPositions = new Map();
}

function registerPosition(nodeId, x, y) {
  const gridX = Math.floor(x / 30);
  const gridY = Math.floor(y / 30);
  const key = `${gridX}_${gridY}`;
  occupiedPositions.set(key, { nodeId, x, y });
}

function isPositionFree(x, y, width = LAYOUT_CONFIG.NODE_WIDTH, height = LAYOUT_CONFIG.NODE_HEIGHT) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã —Å —É—á–µ—Ç–æ–º —Ä–∞–∑–º–µ—Ä–∞ –±–ª–æ–∫–∞
  if (x < BOUNDARIES.minX || y < BOUNDARIES.minY) {
    return false;
  }
  if (x + width > BOUNDARIES.maxX || y + height > BOUNDARIES.maxY) {
    return false;
  }

  const startGridX = Math.floor(x / 30);
  const startGridY = Math.floor(y / 30);
  const endGridX = Math.floor((x + width) / 30);
  const endGridY = Math.floor((y + height) / 30);

  for (let gridX = startGridX; gridX <= endGridX; gridX++) {
    for (let gridY = startGridY; gridY <= endGridY; gridY++) {
      const key = `${gridX}_${gridY}`;
      if (occupiedPositions.has(key)) return false;
    }
  }
  return true;
}

function getViewportCenter() {
  // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—Ç—Ä –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏
  const containerWidth = canvasContainer.clientWidth;
  const containerHeight = canvasContainer.clientHeight;

  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —ç–∫—Ä–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –º–∏—Ä–æ–≤—ã–µ
  const worldX = (-translateX + containerWidth / 2) / scale;
  const worldY = (-translateY + containerHeight / 2) / scale;

  return {
    x: worldX - LAYOUT_CONFIG.NODE_WIDTH / 2,
    y: worldY - LAYOUT_CONFIG.NODE_HEIGHT / 2
  };
}

function findFreePosition(nearX, nearY) {
  // –ï—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—Ç—Ä –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏
  let targetX = nearX;
  let targetY = nearY;

  if ((!targetX && targetX !== 0) || (!targetY && targetY !== 0)) {
    const viewportCenter = getViewportCenter();
    targetX = viewportCenter.x;
    targetY = viewportCenter.y;
  }

  // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —É–∫–∞–∑–∞–Ω–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
  if (isPositionFree(targetX, targetY)) {
    const clampedPos = clampToBoundaries(targetX, targetY);
    return { x: clampedPos.x, y: clampedPos.y };
  }

  // –ò—â–µ–º —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –ø–æ —Å–ø–∏—Ä–∞–ª–∏ –æ—Ç —É–∫–∞–∑–∞–Ω–Ω–æ–π —Ç–æ—á–∫–∏
  for (let radius = 1; radius <= 15; radius++) {
    const points = 8;
    for (let i = 0; i < points; i++) {
      const angle = (i * 360) / points;
      const rad = angle * Math.PI / 180;
      const x = targetX + Math.cos(rad) * radius * 120;
      const y = targetY + Math.sin(rad) * radius * 100;

      if (isPositionFree(x, y)) {
        const clampedPos = clampToBoundaries(x, y);
        return { x: clampedPos.x, y: clampedPos.y };
      }
    }
  }

  // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –≥—Ä–∞–Ω–∏—Ü
  const clampedPos = clampToBoundaries(targetX, targetY);
  return { x: clampedPos.x, y: clampedPos.y };
}

function clampToBoundaries(x, y, width = LAYOUT_CONFIG.NODE_WIDTH, height = LAYOUT_CONFIG.NODE_HEIGHT) {
  const clampedX = Math.max(BOUNDARIES.minX, Math.min(BOUNDARIES.maxX - width, x));
  const clampedY = Math.max(BOUNDARIES.minY, Math.min(BOUNDARIES.maxY - height, y));
  return { x: clampedX, y: clampedY };
}

// ========== –°–û–•–†–ê–ù–ï–ù–ò–ï –ò –ó–ê–ì–†–£–ó–ö–ê ==========
function saveState(debounceMs = 200){
  if(_saveTimeout) clearTimeout(_saveTimeout);
  _saveTimeout = setTimeout(()=> {
    try {
      const state = serializeState();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch(e){ console.error('saveState', e); }
  }, debounceMs);
}

function serializeState(){
  const nodes = Array.from(document.querySelectorAll('.node[data-id]')).map(n => ({
    id: n.dataset.id,
    left: parseFloat(n.style.left) || 0,
    top: parseFloat(n.style.top) || 0,
    title: n.querySelector('.title')?.innerText || '',
    type: n.dataset.type || '',
    collapsed: n.dataset.collapsed === 'true'
  }));

  const panelRect = sidePanel.getBoundingClientRect();
  const editorRect = document.getElementById('editorPage').getBoundingClientRect();
  const panelState = {
    left: panelRect.left - editorRect.left,
    top: panelRect.top - editorRect.top,
    width: panelRect.width,
    height: panelRect.height,
    hidden: sidePanel.style.display === 'none'
  };

  const viewState = { scale, translateX, translateY };

  return {
    version: 3,
    nodes,
    edges,
    nodeCounter,
    aiOutput: document.getElementById('ai-output')?.innerHTML || '',
    isLockedUntil,
    viewState,
    panelState
  };
}

function loadState(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);

    // –í—Å–µ–≥–¥–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –Ω–∞ –∫–æ—Ä–Ω–µ–≤–æ–º –±–ª–æ–∫–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    if(raw) {
      const s = JSON.parse(raw);
      if(s) {
        if(typeof s.nodeCounter === 'number') nodeCounter = s.nodeCounter;

        resetOccupiedPositions();

        if (s.viewState && s.version >= 3) {
          scale = s.viewState.scale || ZOOM_CONFIG.default;
          translateX = s.viewState.translateX || 0;
          translateY = s.viewState.translateY || 0;
        }

        const root = document.querySelector('[data-id="root"]');
        if(root){
          const savedRoot = (s.nodes || []).find(n=>n.id === 'root');
          if(savedRoot){
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ—Ä–Ω–µ–≤–æ–π –±–ª–æ–∫
            const clampedPos = clampToBoundaries(savedRoot.left||0, savedRoot.top||0);
            root.style.left = clampedPos.x + 'px';
            root.style.top = clampedPos.y + 'px';
            const t = root.querySelector('.title');
            if(t) t.innerText = savedRoot.title || '';
            registerPosition('root', clampedPos.x, clampedPos.y);
          }
        }

        document.querySelectorAll('.node').forEach(n => { if(n.dataset.id !== 'root') n.remove(); });
        edges = [];

        if(Array.isArray(s.nodes)){
          s.nodes.forEach(n => {
            if(n.id === 'root') return;
            const clampedPos = clampToBoundaries(n.left || 100, n.top || 100);
            const node = recreateNode(n.id, clampedPos.x, clampedPos.y, n.title || '–ù–æ–≤—ã–π –∫–∞–¥—Ä');
            if(n.type) node.dataset.type = n.type;
            registerPosition(n.id, clampedPos.x, clampedPos.y);
          });
        }

        if(Array.isArray(s.edges)) edges = s.edges.slice();
        if(s.aiOutput !== undefined) document.getElementById('ai-output').innerHTML = s.aiOutput || '';

        if(s.panelState){
          const editorRect = document.getElementById('editorPage').getBoundingClientRect();
          sidePanel.style.left = (s.panelState.left || 0) + 'px';
          sidePanel.style.top = (s.panelState.top || 0) + 'px';
          sidePanel.style.right = 'auto';
          if(s.panelState.width) sidePanel.style.width = s.panelState.width + 'px';
          if(s.panelState.height) sidePanel.style.height = s.panelState.height + 'px';
          if(s.panelState.hidden) {
            sidePanel.style.display = 'none';
            openPanelBtn.classList.add('visible');
          }
        }

        if(s.isLockedUntil){
          isLockedUntil = s.isLockedUntil;
          updateTimerUI();
          if(isLockedUntil > Date.now()){
            timerInterval && clearInterval(timerInterval);
            timerInterval = setInterval(updateTimerUI, 250);
          }
        }
      }
    } else {
      // –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ - —Å–æ–∑–¥–∞–µ–º –∫–æ—Ä–Ω–µ–≤–æ–π –±–ª–æ–∫ –≤ —Ü–µ–Ω—Ç—Ä–µ
      const root = document.querySelector('[data-id="root"]');
      if(root) {
        const centerX = LAYOUT_CONFIG.CANVAS_WIDTH / 2 - LAYOUT_CONFIG.NODE_WIDTH / 2;
        const centerY = LAYOUT_CONFIG.CANVAS_HEIGHT / 2 - LAYOUT_CONFIG.NODE_HEIGHT / 2;

        root.style.left = centerX + 'px';
        root.style.top = centerY + 'px';
        registerPosition('root', centerX, centerY);
      }
    }

    // –í–°–ï–ì–î–ê —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –Ω–∞ –∫–æ—Ä–Ω–µ–≤–æ–º –±–ª–æ–∫–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
    centerOnRoot();

    renderConnections();
    updateAIPreview();
  } catch(e){ console.error('loadState', e); }
}

// ========== –¢–ê–ô–ú–ï–† ==========
function setLock(seconds){
  isLockedUntil = Date.now() + seconds*1000;
  updateTimerUI();
  timerInterval && clearInterval(timerInterval);
  timerInterval = setInterval(updateTimerUI, 250);
  saveState();
}

function updateTimerUI(){
  const el = document.getElementById('ai-timer');
  const runBtn = document.getElementById('ai-next-frame');
  const analyzeBtn = document.getElementById('ai-analyze-frames');
  const remaining = Math.max(0, Math.ceil((isLockedUntil - Date.now()) / 1000));
  if(remaining > 0){
    el.innerText = `${remaining}s`;
    runBtn.disabled = true;
    analyzeBtn.disabled = true;
    runBtn.style.opacity='0.6';
    analyzeBtn.style.opacity='0.6';
  } else {
    el.innerText = '‚Äî';
    runBtn.disabled = false;
    analyzeBtn.disabled = false;
    runBtn.style.opacity='';
    analyzeBtn.style.opacity='';
    if(timerInterval){
      clearInterval(timerInterval);
      timerInterval=null;
    }
    if(isLockedUntil !== 0){
      isLockedUntil = 0;
      saveState();
    }
  }
}

// ========== –£–ó–õ–´ –ò –ò–ù–¢–ï–†–§–ï–ô–° ==========
function byId(id){ return document.querySelector(`[data-id="${id}"]`); }
function genId(){ nodeCounter = (nodeCounter||0) + 1; saveState(); return 'node-' + nodeCounter; }

function recreateNode(id, x=100, y=200, text='–ù–æ–≤—ã–π –∫–∞–¥—Ä'){
  const div = document.createElement('div');
  div.className = 'node';

  const clampedPos = clampToBoundaries(x, y);
  div.style.left = clampedPos.x + 'px';
  div.style.top = clampedPos.y + 'px';

  div.dataset.id = id;
  div.dataset.type = 'frame';
  div.innerHTML = `
    <div contenteditable class="title">${text}</div>
    <div class="controls">
      <div class="small-muted">–ö–∞–¥—Ä</div>
      <div class="buttons-container">
        <div class="add-btn" title="–î–æ–±–∞–≤–∏—Ç—å –∫–∞–¥—Ä" data-add>+</div>
        <div class="next-frame-btn" title="–°–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä (–ò–ò)" data-next-frame>‚Üí</div>
        ${id==='root' ? '' : '<div class="remove-btn" title="–£–¥–∞–ª–∏—Ç—å –∫–∞–¥—Ä">‚úï</div>'}
      </div>
    </div>
  `;
  canvasContent.appendChild(div);
  makeDraggable(div);
  setupNodeButtons(div);
  const t = div.querySelector('.title');
  if(t) t.addEventListener('input', ()=>{ updateAIPreview(); saveState(); });
  return div;
}

function createNode(x=100, y=200, text='–ù–æ–≤—ã–π –∫–∞–¥—Ä', parentId=null, type='frame'){
  const id = genId();
  const freePos = findFreePosition(x, y);
  const node = recreateNode(id, freePos.x, freePos.y, text);
  if(type) node.dataset.type = type;
  if(parentId) addEdge(parentId, id);

  registerPosition(id, freePos.x, freePos.y);
  updateAIPreview();
  renderConnections();
  saveState();
  return id;
}

function makeDraggable(elem){
  let dragging=false, startX=0, startY=0, origLeft=0, origTop=0;

  elem.addEventListener('mousedown', e=>{
    if(e.target.closest('.add-btn, .remove-btn, .next-frame-btn, .analyze-btn')) return;
    if(e.target.closest('.title')) return;
    dragging=true;
    startX=e.clientX;
    startY=e.clientY;
    origLeft=parseFloat(elem.style.left)||0;
    origTop=parseFloat(elem.style.top)||0;
    e.preventDefault();
    elem.style.zIndex = '1000';
  });

  document.addEventListener('mousemove', e=>{
    if(!dragging) return;
    const dx=e.clientX-startX;
    const dy=e.clientY-startY;

    let newLeft = origLeft+dx;
    let newTop = origTop+dy;

    // –ü—Ä–∏–º–µ–Ω—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏
    const clampedPos = clampToBoundaries(newLeft, newTop);
    newLeft = clampedPos.x;
    newTop = clampedPos.y;

    elem.style.left=newLeft+'px';
    elem.style.top=newTop+'px';
    renderConnections();
  });

  document.addEventListener('mouseup', ()=>{
    if(!dragging) return;
    dragging=false;
    elem.style.zIndex='';

    const finalLeft = parseFloat(elem.style.left)||0;
    const finalTop = parseFloat(elem.style.top)||0;

    registerPosition(elem.dataset.id, finalLeft, finalTop);
    saveState();
    renderConnections();
  });
}

function setupNodeButtons(node){
  const addBtn = node.querySelector('[data-add]');
  const nextFrameBtn = node.querySelector('[data-next-frame]');
  const removeBtn = node.querySelector('.remove-btn');

  if(addBtn) addBtn.addEventListener('click', e=>{
    e.stopPropagation();
    const rect = node.getBoundingClientRect();
    const canvasRect = canvasContent.getBoundingClientRect();

    let newX = rect.left - canvasRect.left + 400;
    let newY = rect.top - canvasRect.top;

    // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é, —á—Ç–æ–±—ã –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç—å –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã
    const clampedX = Math.min(newX, BOUNDARIES.maxX - LAYOUT_CONFIG.NODE_WIDTH);

    createNode(clampedX, newY, '–ù–æ–≤—ã–π –∫–∞–¥—Ä', node.dataset.id, 'frame');
  });

  if(nextFrameBtn) nextFrameBtn.addEventListener('click', e=>{
    e.stopPropagation();
    generateNextFrame(node);
  });

  if(removeBtn) removeBtn.addEventListener('click', e=>{
    e.stopPropagation();
    removeNode(node.dataset.id);
  });
}

function removeNode(id){
  const node = byId(id);
  if(!node) return;
  const childEdges = edges.filter(e => e.from === id);
  childEdges.forEach(e => removeNode(e.to));
  edges = edges.filter(e => e.from !== id && e.to !== id);
  node.remove();
  updateAIPreview();
  renderConnections();
  saveState();
}

function addEdge(fromId, toId){
  edges.push({from: fromId, to: toId});
  renderConnections();
}

// ========== –û–¢–†–ò–°–û–í–ö–ê –°–û–ï–î–ò–ù–ï–ù–ò–ô ==========
function renderConnections(){
  const svg = connectorsSvg;
  svg.innerHTML = '';
  edges.forEach(e => {
    const fromNode = byId(e.from);
    const toNode = byId(e.to);
    if(!fromNode || !toNode) return;

    const fromX = parseFloat(fromNode.style.left) + fromNode.offsetWidth / 2;
    const fromY = parseFloat(fromNode.style.top) + fromNode.offsetHeight;
    const toX = parseFloat(toNode.style.left) + toNode.offsetWidth / 2;
    const toY = parseFloat(toNode.style.top);

    const midY = (fromY + toY) / 2;
    const controlOffset = Math.min(Math.abs(toX - fromX) * 0.5, 150);

    const pathData = `M ${fromX} ${fromY}
                     C ${fromX} ${fromY + controlOffset},
                       ${toX} ${toY - controlOffset},
                       ${toX} ${toY}`;

    // –ì–ª–æ—É —ç—Ñ—Ñ–µ–∫—Ç
    const glow = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    glow.setAttribute('d', pathData);
    glow.setAttribute('stroke', 'rgba(0,217,255,0.15)');
    glow.setAttribute('stroke-width', '8');
    glow.setAttribute('fill', 'none');
    glow.setAttribute('stroke-linecap', 'round');
    glow.style.filter = 'blur(8px)';
    svg.appendChild(glow);

    // –û—Å–Ω–æ–≤–Ω–∞—è –ª–∏–Ω–∏—è
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('d', pathData);
    path.setAttribute('stroke', 'var(--neon)');
    path.setAttribute('stroke-width', '3');
    path.setAttribute('fill', 'none');
    path.setAttribute('stroke-linecap', 'round');
    path.style.filter = 'drop-shadow(0 0 6px rgba(0,217,255,0.3))';
    svg.appendChild(path);

    // –°—Ç—Ä–µ–ª–∫–∞
    const arrowSize = 8;
    const angle = Math.atan2(toY - (fromY + controlOffset), toX - fromX);

    const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
    const points = `
      ${toX},${toY}
      ${toX - arrowSize * Math.cos(angle - Math.PI/6)},${toY - arrowSize * Math.sin(angle - Math.PI/6)}
      ${toX - arrowSize * Math.cos(angle + Math.PI/6)},${toY - arrowSize * Math.sin(angle + Math.PI/6)}
    `;
    arrow.setAttribute('points', points);
    arrow.setAttribute('fill', 'var(--neon)');
    arrow.style.filter = 'drop-shadow(0 0 4px rgba(0,217,255,0.5))';
    svg.appendChild(arrow);
  });
}

// ========== AI –§–£–ù–ö–¶–ò–ò ==========
function collectTreeText(){
  const root = byId('root');
  const title = root ? root.querySelector('.title').innerText.trim() : '';
  const outcomes = Array.from(document.querySelectorAll('.node[data-type="frame"]'))
                    .map(n => n.querySelector('.title').innerText.trim())
                    .filter(Boolean);
  return { title, outcomes };
}

function updateAIPreview(){
  const {title,outcomes} = collectTreeText();
  document.getElementById('ai-title').innerText = title || '‚Äî';
  document.getElementById('ai-outcomes').innerText = outcomes.length ? ('‚Ä¢ ' + outcomes.join('\n‚Ä¢ ')) : '‚Äî';
}

function parseNextFrameResponse(text){
  if(!text) return { nextFrame: '', visualElements: [], emotionalImpact: [] };

  const nextFrameMatch = text.match(/–°–õ–ï–î–£–Æ–©–ò–ô –ö–ê–î–†:\s*([^\n]+)/i);
  const visualMatch = text.match(/–í–ò–ó–£–ê–õ–¨–ù–´–ï –≠–õ–ï–ú–ï–ù–¢–´:\s*([^\n]+)/i);
  const emotionalMatch = text.match(/–≠–ú–û–¶–ò–û–ù–ê–õ–¨–ù–û–ï –í–û–ó–î–ï–ô–°–¢–í–ò–ï:\s*([^\n]+)/i);

  const nextFrame = nextFrameMatch ? nextFrameMatch[1].trim() : '';
  const visualElements = visualMatch ? visualMatch[1].split(';').map(item => item.trim()).filter(Boolean) : [];
  const emotionalImpact = emotionalMatch ? emotionalMatch[1].split(';').map(item => item.trim()).filter(Boolean) : [];

  return { nextFrame, visualElements, emotionalImpact };
}

function parseFrameAnalysisResponse(text){
  if(!text) return { bestFrame: '', explanation: '', strengths: [], improvements: [] };

  const bestFrameMatch = text.match(/–õ–£–ß–®–ò–ô –ö–ê–î–†:\s*([^\n]+)/i);
  const explanationMatch = text.match(/–ü–û–ß–ï–ú–£ –≠–¢–û–¢ –ö–ê–î–†:\s*([^\n]+)/i);
  const strengthsMatch = text.match(/–°–ò–õ–¨–ù–´–ï –°–¢–û–†–û–ù–´:\s*([^\n]+)/i);
  const improvementsMatch = text.match(/–í–û–ó–ú–û–ñ–ù–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø:\s*([^\n]+)/i);

  const bestFrame = bestFrameMatch ? bestFrameMatch[1].trim() : '';
  const explanation = explanationMatch ? explanationMatch[1].trim() : '';
  const strengths = strengthsMatch ? strengthsMatch[1].split(';').map(item => item.trim()).filter(Boolean) : [];
  const improvements = improvementsMatch ? improvementsMatch[1].split(';').map(item => item.trim()).filter(Boolean) : [];

  return { bestFrame, explanation, strengths, improvements };
}

// ========== –ì–ï–ù–ï–†–ê–¶–ò–Ø –°–õ–ï–î–£–Æ–©–ï–ì–û –ö–ê–î–†–ê ==========
async function generateNextFrame(parentNode){
  if(isLockedUntil > Date.now()) return;

  const { title } = collectTreeText();
  const currentFrame = parentNode.querySelector('.title').innerText.trim();
  const outBox = document.getElementById('ai-output');

  if(!title){
    outBox.innerText = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ —Ç–µ–º—É —Å—Ü–µ–Ω—ã –≤ –Ω–∞—á–∞–ª—å–Ω–æ–º –∫–∞–¥—Ä–µ.';
    return;
  }

  if(!currentFrame){
    outBox.innerText = '–ö–∞–¥—Ä –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.';
    return;
  }

  outBox.innerHTML = '';
  const loading = document.createElement('div');
  loading.className = 'ai-response';
  loading.innerHTML = `<div class="meta"><b>–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä...</b></div>`;
  outBox.appendChild(loading);
  outBox.scrollTop = outBox.scrollHeight;

  aiNextFrameBtn.disabled = true;
  aiNextFrameBtn.style.opacity = '0.6';

  try {
    const response = await fetch('/run-ai-flow-next-frame', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ title, current_frame: currentFrame })
    });

    if(!response.ok) throw new Error('HTTP ' + response.status);

    const data = await response.json();
    const result = data.result || '';

    if(outBox.lastElementChild === loading) outBox.removeChild(loading);

    const { nextFrame, visualElements, emotionalImpact } = parseNextFrameResponse(result);

    if(nextFrame) {
      const rect = parentNode.getBoundingClientRect();
      const canvasRect = canvasContent.getBoundingClientRect();

      let newX = rect.left - canvasRect.left + 400;
      let newY = rect.top - canvasRect.top;

      // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é, —á—Ç–æ–±—ã –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç—å –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã
      newX = Math.min(newX, BOUNDARIES.maxX - LAYOUT_CONFIG.NODE_WIDTH);
      newY = Math.min(newY, BOUNDARIES.maxY - LAYOUT_CONFIG.NODE_HEIGHT);

      createNode(newX, newY, nextFrame, parentNode.dataset.id, 'frame');

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∞–ª–∏–∑ –≤ –ø–∞–Ω–µ–ª–∏
      const analysisHTML = `
        <div class="ai-response result-highlight">
          <div class="meta"><b>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Å–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä:</b> ${nextFrame}</div>
          ${visualElements.length > 0 ? `
            <div style="margin-top: 8px;">
              <div style="color: var(--visual-color); font-weight: 600; font-size: 12px;">üé¨ –í–∏–∑—É–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã:</div>
              <ul class="visual-list">
                ${visualElements.map(el => `<li>${escapeHtml(el)}</li>`).join('')}
              </ul>
            </div>
          ` : ''}
          ${emotionalImpact.length > 0 ? `
            <div style="margin-top: 8px;">
              <div style="color: var(--emotional-color); font-weight: 600; font-size: 12px;">üí´ –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ:</div>
              <ul class="emotional-list">
                ${emotionalImpact.map(em => `<li>${escapeHtml(em)}</li>`).join('')}
              </ul>
            </div>
          ` : ''}
        </div>
      `;

      outBox.innerHTML = analysisHTML;
    } else {
      outBox.innerHTML = `<div class="ai-response">–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.</div>`;
    }

    setLock(30);
  } catch(error) {
    console.error('AI request failed:', error);
    if(outBox.lastElementChild === loading) {
      loading.innerHTML = `<div class="meta"><b>–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞–¥—Ä–∞.</b></div>`;
    } else {
      outBox.innerHTML = `<div class="ai-response">–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞–¥—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</div>`;
    }
  }

  aiNextFrameBtn.disabled = false;
  aiNextFrameBtn.style.opacity = '';
}

// ========== –ê–ù–ê–õ–ò–ó –ö–ê–î–†–û–í ==========
function showFrameAnalysisModal(){
  const frames = Array.from(document.querySelectorAll('.node[data-type="frame"]'));

  if(frames.length < 2) {
    document.getElementById('ai-output').innerHTML = '<div class="ai-response">–î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –Ω—É–∂–Ω–æ –∫–∞–∫ –º–∏–Ω–∏–º—É–º 2 –∫–∞–¥—Ä–∞.</div>';
    return;
  }

  frameList.innerHTML = '';
  selectedFramesForAnalysis.clear();

  frames.forEach((frame, index) => {
    const frameText = frame.querySelector('.title').innerText.trim();
    const frameItem = document.createElement('div');
    frameItem.className = 'frame-item';
    frameItem.innerHTML = `
      <div style="font-weight: 600; font-size: 12px;">–ö–∞–¥—Ä ${index + 1}</div>
      <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">${frameText}</div>
    `;

    frameItem.addEventListener('click', () => {
      frameItem.classList.toggle('selected');
      if(frameItem.classList.contains('selected')) {
        selectedFramesForAnalysis.add(frameText);
      } else {
        selectedFramesForAnalysis.delete(frameText);
      }
    });

    frameList.appendChild(frameItem);
  });

  frameAnalysisModal.classList.add('active');
}

async function analyzeSelectedFrames(){
  if(selectedFramesForAnalysis.size < 2) {
    alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–∫ –º–∏–Ω–∏–º—É–º 2 –∫–∞–¥—Ä–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞');
    return;
  }

  const { title } = collectTreeText();
  const frames = Array.from(selectedFramesForAnalysis);
  const outBox = document.getElementById('ai-output');

  outBox.innerHTML = '';
  const loading = document.createElement('div');
  loading.className = 'ai-response';
  loading.innerHTML = `<div class="meta"><b>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞–¥—Ä—ã...</b></div>`;
  outBox.appendChild(loading);

  aiAnalyzeFramesBtn.disabled = true;
  aiAnalyzeFramesBtn.style.opacity = '0.6';
  frameAnalysisModal.classList.remove('active');

  try {
    const response = await fetch('/run-ai-flow-analyze-frames', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ title, frames })
    });

    if(!response.ok) throw new Error('HTTP ' + response.status);

    const data = await response.json();
    const result = data.result || '';

    if(outBox.lastElementChild === loading) outBox.removeChild(loading);

    const { bestFrame, explanation, strengths, improvements } = parseFrameAnalysisResponse(result);

    const analysisHTML = `
      <div class="ai-response result-highlight">
        <div class="meta"><b>–ê–Ω–∞–ª–∏–∑ –∫–∞–¥—Ä–æ–≤:</b></div>
        ${bestFrame ? `
          <div style="margin-top: 8px;">
            <div style="color: var(--frame-color); font-weight: 600; font-size: 12px;">üèÜ –õ—É—á—à–∏–π –∫–∞–¥—Ä:</div>
            <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">${bestFrame}</div>
          </div>
        ` : ''}
        ${explanation ? `
          <div style="margin-top: 8px;">
            <div style="color: var(--accent); font-weight: 600; font-size: 12px;">üìù –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:</div>
            <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">${explanation}</div>
          </div>
        ` : ''}
        ${strengths.length > 0 ? `
          <div style="margin-top: 8px;">
            <div style="color: var(--pro-color); font-weight: 600; font-size: 12px;">‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:</div>
            <ul style="color: var(--text-muted); font-size: 12px; margin: 4px 0; padding-left: 16px;">
              ${strengths.map(st => `<li>${escapeHtml(st)}</li>`).join('')}
            </ul>
          </div>
        ` : ''}
        ${improvements.length > 0 ? `
          <div style="margin-top: 8px;">
            <div style="color: var(--con-color); font-weight: 600; font-size: 12px;">üí° –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:</div>
            <ul style="color: var(--text-muted); font-size: 12px; margin: 4px 0; padding-left: 16px;">
              ${improvements.map(im => `<li>${escapeHtml(im)}</li>`).join('')}
            </ul>
          </div>
        ` : ''}
      </div>
    `;

    outBox.innerHTML = analysisHTML;
    setLock(30);
  } catch(error) {
    console.error('Analysis request failed:', error);
    if(outBox.lastElementChild === loading) {
      loading.innerHTML = `<div class="meta"><b>–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –∫–∞–¥—Ä–æ–≤.</b></div>`;
    } else {
      outBox.innerHTML = `<div class="ai-response">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –∫–∞–¥—Ä–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</div>`;
    }
  }

  aiAnalyzeFramesBtn.disabled = false;
  aiAnalyzeFramesBtn.style.opacity = '';
}

// ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–ù–û–ü–û–ö ==========
aiNextFrameBtn.addEventListener('click', () => {
  const frames = Array.from(document.querySelectorAll('.node[data-type="frame"]'));
  const lastFrame = frames[frames.length - 1];
  if(lastFrame) {
    generateNextFrame(lastFrame);
  }
});

aiAnalyzeFramesBtn.addEventListener('click', showFrameAnalysisModal);

modalAnalyze.addEventListener('click', analyzeSelectedFrames);
modalCancel.addEventListener('click', () => {
  frameAnalysisModal.classList.remove('active');
});

// ========== –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø ==========
panelCloseBtn.addEventListener('click', () => {
  sidePanel.style.display = 'none';
  openPanelBtn.classList.add('visible');
  saveState();
});

openPanelBtn.addEventListener('click', () => {
  sidePanel.style.display = 'flex';
  openPanelBtn.classList.remove('visible');
  saveState();
});

// ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
function escapeHtml(s){
  if(!s && s!==0) return '';
  return String(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#39;');
}

// ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
function init(){
  loadState();
  updateTimerUI();
  updateAIPreview();

  const root = byId('root');
  if(root){
    makeDraggable(root);
    setupNodeButtons(root);
    const t = root.querySelector('.title');
    if(t) t.addEventListener('input', ()=>{ updateAIPreview(); saveState(); });
  }

  // Double-click on canvas to create new frame
  canvasContent.addEventListener('dblclick', e => {
    const target = e.target;
    if(target.closest('.node') || target.closest('.add-btn') || target.closest('.remove-btn')) return;

    const rect = canvasContent.getBoundingClientRect();
    const x = e.clientX - rect.left - LAYOUT_CONFIG.NODE_WIDTH / 2;
    const y = e.clientY - rect.top - LAYOUT_CONFIG.NODE_HEIGHT / 2;

    createNode(x, y, '–ù–æ–≤—ã–π –∫–∞–¥—Ä');
  });

  // Auto-save on title edits
  document.addEventListener('input', e => {
    if(e.target.classList.contains('title')){
      updateAIPreview();
      saveState();
    }
  });

  // Periodically save state
  setInterval(saveState, 30000);
}

init();
</script>
</body>
</html>
