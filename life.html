<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Путь Жизни — Viora</title>
<link rel="stylesheet" href="styles.css">
<style>
.editor-page {
  width: 100vw;
  height: 100vh;
  display:flex;
  gap:20px;
  padding:20px;
  align-items: stretch;
  box-sizing: border-box;
  font-family: 'Inter', system-ui, sans-serif;
}
.canvas-area {
  flex: 1 1 auto;
  border-radius: 18px;
  background: rgba(10,10,15,0.45);
  backdrop-filter: blur(8px);
  position: relative;
  overflow: auto;
  padding: 40px;
  min-height: 80vh;
}
.side-panel {
  width: 420px;
  max-width: 40%;
  background: rgba(8,8,10,0.6);
  border-radius: 16px;
  padding: 18px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.6);
  color: #fff;
}
.node {
  width:260px;
  min-height:56px;
  background: rgba(255,255,255,0.03);
  border:1px solid rgba(255,255,255,0.08);
  border-radius:14px;
  padding:12px;
  box-sizing:border-box;
  position:absolute;
  display:flex;
  flex-direction:column;
  gap:8px;
  cursor: default;
}
.node .title[contenteditable] {
  cursor: text;
}
.node .add-btn,
.node .remove-btn {
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  user-select: none;
}
.add-btn {
  width:28px;
  height:28px;
  border-radius:8px;
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.06);
}
.remove-btn {
  width:26px;
  height:26px;
  border-radius:8px;
  background: rgba(255,255,255,0.02);
  border:1px solid rgba(255,255,255,0.06);
}
.connector-svg {
  position:absolute;
  inset:0;
  pointer-events:none;
}
.small-muted { color: rgba(255,255,255,0.5); font-size:13px; }
.back-link {
  position: fixed;
  top: 14px;
  left: 14px;
  z-index: 9999;
  background: rgba(255, 255, 255, 0.06);
  color: #ffffff;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 8px 10px;
  border-radius: 10px;
  border: 1px solid rgba(255, 255, 255, 0.08);
  font-weight: 600;
  box-shadow: 0 6px 20px rgba(0,0,0,0.5);
}
.button-primary { background:var(--color-primary); color:#0a0a0f; padding:10px 12px; border-radius:10px; cursor:pointer; border:none; }
.button-ghost { background:transparent; color: #fff; border:1px solid rgba(255,255,255,0.08); padding:10px 12px; border-radius:10px; cursor:pointer; }
</style>
</head>
<body>
<a class="back-link" href="/viora">← Назад</a>
<div class="editor-page">
  <div class="canvas-area" id="canvasArea">
    <svg class="connector-svg" id="connectors" width="100%" height="100%"></svg>

    <!-- Главный узел -->
    <div class="node" id="node-root" style="left: calc(50% - 110px); top: 80px;" data-id="root">
      <div contenteditable class="title" data-placeholder="Опишите проблему...">Нажмите и впишите проблему</div>
      <div style="display:flex; justify-content:space-between; align-items:center">
        <div class="small-muted">Главный пункт</div>
        <div class="add-btn" title="Добавить исход">+</div>
      </div>
    </div>

  </div>

  <div class="side-panel">
    <h3>ИИ-помощник</h3>
    <div class="small-muted">Он читает заголовок и все исходы, затем предлагает лучший вариант.</div>

    <div style="height:12px"></div>
    <div style="font-weight:600">Заголовок (проблема)</div>
    <div id="ai-title" class="small-muted"></div>

    <div style="height:10px"></div>
    <div style="font-weight:600">Исходы</div>
    <div id="ai-outcomes" class="small-muted"></div>

    <div style="height:12px"></div>
    <div class="ai-box" id="ai-output">Нажмите «Предложить», чтобы ИИ проанализировал варианты.</div>

    <div style="height:12px"></div>
    <div style="display:flex; gap:10px">
      <button class="button-primary" id="ai-run">Предложить</button>
      <button class="button-ghost" id="ai-reset">Сбросить подсказку</button>
    </div>
  </div>
</div>

<script>
// JS логика (аналог второго файла)
let nodeCounter = 1;
const canvas = document.getElementById('canvasArea');
const connectorsSvg = document.getElementById('connectors');
const edges = [];

function createNode(x=100,y=200,text='Новый исход',parentId=null){
  const id='node-'+(++nodeCounter);
  const div=document.createElement('div');
  div.className='node';
  div.style.left=x+'px';
  div.style.top=y+'px';
  div.dataset.id=id;
  div.innerHTML=`
    <div contenteditable class="title">${text}</div>
    <div style="display:flex; justify-content:space-between; align-items:center">
      <div class="small-muted">Исход</div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="add-btn" title="Добавить исход">+</div>
        <div class="remove-btn" title="Удалить узел">✕</div>
      </div>
    </div>
  `;
  canvas.appendChild(div);
  makeDraggable(div);
  setupNodeButtons(div);
  if(parentId) addEdge(parentId,id);
  updateAIPreview();
  renderConnections();
  return id;
}

function makeDraggable(elem){
  let dragging=false, dx=0, dy=0;
  elem.addEventListener('mousedown', e=>{
    if(e.target.closest('.add-btn')||e.target.closest('.remove-btn')) return;
    dragging=true;
    const rect=elem.getBoundingClientRect();
    dx=e.clientX-rect.left;
    dy=e.clientY-rect.top;
    elem.style.zIndex=1000;
  });
  document.addEventListener('mousemove', e=>{
    if(!dragging) return;
    const rect=canvas.getBoundingClientRect();
    elem.style.left=(e.clientX-rect.left-dx)+'px';
    elem.style.top=(e.clientY-rect.top-dy)+'px';
    renderConnections();
  });
  document.addEventListener('mouseup', ()=>{
    if(dragging){dragging=false; elem.style.zIndex='';}
  });
}

function addEdge(fromId,toId){ edges.push({from:fromId,to:toId}); renderConnections(); }

function renderConnections(){
  connectorsSvg.innerHTML='';
  edges.forEach(e=>{
    const a=document.querySelector(`[data-id="${e.from}"]`);
    const b=document.querySelector(`[data-id="${e.to}"]`);
    if(!a||!b) return;
    const ra=a.getBoundingClientRect(), rb=b.getBoundingClientRect();
    const cr=canvas.getBoundingClientRect();
    const x1=ra.left+ra.width/2-cr.left, y1=ra.top+ra.height-cr.top;
    const x2=rb.left+rb.width/2-cr.left, y2=rb.top-cr.top;
    const path=document.createElementNS('http://www.w3.org/2000/svg','path');
    const dx=Math.max(40,Math.abs(x2-x1)/2);
    path.setAttribute('d',`M ${x1} ${y1} C ${x1} ${y1+dx} ${x2} ${y2-dx} ${x2} ${y2}`);
    path.setAttribute('stroke','rgba(255,255,255,0.12)');
    path.setAttribute('stroke-width','2');
    path.setAttribute('fill','none');
    connectorsSvg.appendChild(path);
  });
}

function setupNodeButtons(nodeElem){
  const addBtn=nodeElem.querySelector('.add-btn');
  const removeBtn=nodeElem.querySelector('.remove-btn');
  const title=nodeElem.querySelector('.title');

  addBtn?.addEventListener('click', e=>{
    e.stopPropagation();
    const rect=nodeElem.getBoundingClientRect();
    const cr=canvas.getBoundingClientRect();
    createNode(rect.left-cr.left+rect.width+40,rect.top-cr.top,'Вариант решения...',nodeElem.dataset.id);
  });

  removeBtn?.addEventListener('click', e=>{
    e.stopPropagation();
    removeNode(nodeElem.dataset.id);
  });

  title?.addEventListener('input', updateAIPreview);
}

function removeNode(nodeId){
  const node=document.querySelector(`[data-id="${nodeId}"]`);
  if(!node) return;
  for(let i=edges.length-1;i>=0;i--){if(edges[i].from===nodeId||edges[i].to===nodeId) edges.splice(i,1);}
  node.remove();
  renderConnections();
  updateAIPreview();
}

function collectTreeText(){
  const root=document.querySelector('[data-id="root"]');
  const title=root?.querySelector('.title')?.innerText.trim()||'';
  const outcomes=Array.from(document.querySelectorAll('.node[data-id]:not([data-id="root"])'))
    .map(n=>n.querySelector('.title')?.innerText.trim())
    .filter(Boolean);
  return {title,outcomes};
}

function updateAIPreview(){
  const {title,outcomes}=collectTreeText();
  document.getElementById('ai-title').innerText=title||'—';
  document.getElementById('ai-outcomes').innerText=outcomes.length?'• '+outcomes.join('\n• '):'—';
}

document.getElementById('ai-run').addEventListener('click', async ()=>{
  const {title,outcomes}=collectTreeText();
  const outBox=document.getElementById('ai-output');
  if(!title){outBox.innerText='Пожалуйста, опишите проблему.'; return;}
  if(!outcomes.length){outBox.innerText='Добавьте варианты решения.'; return;}
  outBox.innerText='Обрабатываем...';
  try{
    const resp=await fetch('main.py/runAi',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({title,outcomes})});
    const data=await resp.json();
    outBox.innerText=data.result;
  }catch(err){console.error(err); outBox.innerText='Ошибка при запросе к AI.';}
});

document.getElementById('ai-reset').addEventListener('click', ()=>{
  document.getElementById('ai-output').innerText='Сброшено.';
});

document.querySelectorAll('.node').forEach(n=>{makeDraggable(n); setupNodeButtons(n);});
window.addEventListener('resize', renderConnections);
canvas.addEventListener('scroll', renderConnections);
updateAIPreview();
</script>
</body>
</html>
